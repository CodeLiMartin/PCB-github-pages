import h5py
import pandas as pd
import os
import time
import numpy as np

# æ•°æ®æ ¹ç›®å½•
root_folder = r"D:\PCBä»¿çœŸ\CNC_Machining-main\data"
print(f"æ•°æ®æ ¹ç›®å½•: {root_folder}")
print(f"æ ¹ç›®å½•å­˜åœ¨: {os.path.exists(root_folder)}")

# è¾“å‡ºç›®å½• - ä¿®æ”¹ä¸ºM02
output_dir = r"D:\PCBä»¿çœŸ\CNC_Machining-main\åˆ†è®¾å¤‡æ•°æ®\M02"
os.makedirs(output_dir, exist_ok=True)
print(f"è¾“å‡ºç›®å½•: {output_dir}")

# å¤„ç† M02 è®¾å¤‡
machine = "M02"
print(f"\n===== æ­£åœ¨å¤„ç†è®¾å¤‡ {machine} =====")

# è·å–å®é™…å­˜åœ¨çš„å·¥åºç›®å½•
process_dirs = [d for d in os.listdir(os.path.join(root_folder, machine))
                if os.path.isdir(os.path.join(root_folder, machine, d)) and d.startswith("OP")]

print(f"æ‰¾åˆ°çš„å·¥åºç›®å½•: {process_dirs}")

# éå†è¯¥è®¾å¤‡ä¸‹çš„æ‰€æœ‰å·¥åº
for process_dir in process_dirs:
    process_id = process_dir
    print(f"\n--- æ­£åœ¨å¤„ç†å·¥åº {process_id} ---")

    process_data = []
    processed_files = 0
    start_time = time.time()

    # æ„å»ºè®¾å¤‡+å·¥åºè·¯å¾„
    process_path = os.path.join(root_folder, machine, process_id)
    print(f"å·¥åºè·¯å¾„: {process_path}")

    if not os.path.exists(process_path):
        print(f"âš ï¸ å·¥åºè·¯å¾„ä¸å­˜åœ¨: {process_path}")
        continue

    # æ£€æŸ¥goodå’Œbadå­ç›®å½•
    quality_paths = []
    for quality in ["good", "bad"]:
        quality_path = os.path.join(process_path, quality)
        if os.path.exists(quality_path):
            quality_paths.append((quality, quality_path))
            print(f"æ‰¾åˆ° {quality} ç›®å½•: {quality_path}")

    if not quality_paths:
        print(f"âš ï¸ å·¥åº {process_id} æ²¡æœ‰æ‰¾åˆ°goodæˆ–badç›®å½•")
        continue

    # éå†æ‰¾åˆ°çš„qualityç›®å½•
    for quality, quality_path in quality_paths:
        files = [f for f in os.listdir(quality_path) if f.endswith(".h5")]
        print(f"åœ¨ {quality} ç›®å½•ä¸­æ‰¾åˆ° {len(files)} ä¸ª .h5 æ–‡ä»¶")

        if not files:
            print(f"âš ï¸ {quality} ç›®å½•ä¸­æ²¡æœ‰.h5æ–‡ä»¶")
            continue

        for file in files:
            file_path = os.path.join(quality_path, file)
            print(f"å¤„ç†æ–‡ä»¶: {file}")

            try:
                with h5py.File(file_path, "r") as f:
                    # æŸ¥æ‰¾æŒ¯åŠ¨æ•°æ®
                    x, y, z = None, None, None

                    # å¯èƒ½æ€§1: æ ¹ç›®å½•ä¸‹æœ‰XYZæ•°æ®é›†
                    if 'X' in f and 'Y' in f and 'Z' in f:
                        x = f['X'][:]
                        y = f['Y'][:]
                        z = f['Z'][:]

                    # å¯èƒ½æ€§2: æœ‰åä¸º'vibration_data'çš„æ•°æ®é›†
                    elif 'vibration_data' in f:
                        data = f['vibration_data'][:]
                        if len(data.shape) == 2 and data.shape[1] >= 3:
                            x = data[:, 0]
                            y = data[:, 1]
                            z = data[:, 2]

                    # å¯èƒ½æ€§3: æœ‰åä¸º'data'çš„æ•°æ®é›†
                    elif 'data' in f:
                        data = f['data'][:]
                        if len(data.shape) == 2 and data.shape[1] >= 3:
                            x = data[:, 0]
                            y = data[:, 1]
                            z = data[:, 2]

                    # å¯èƒ½æ€§4: æœ‰åä¸º'sensor'æˆ–'vibration'çš„ç»„
                    elif 'sensor' in f:
                        group = f['sensor']
                        if 'X' in group and 'Y' in group and 'Z' in group:
                            x = group['X'][:]
                            y = group['Y'][:]
                            z = group['Z'][:]
                        elif 'data' in group:
                            data = group['data'][:]
                            if len(data.shape) == 2 and data.shape[1] >= 3:
                                x = data[:, 0]
                                y = data[:, 1]
                                z = data[:, 2]

                    elif 'vibration' in f:
                        group = f['vibration']
                        if 'X' in group and 'Y' in group and 'Z' in group:
                            x = group['X'][:]
                            y = group['Y'][:]
                            z = group['Z'][:]
                        elif 'data' in group:
                            data = group['data'][:]
                            if len(data.shape) == 2 and data.shape[1] >= 3:
                                x = data[:, 0]
                                y = data[:, 1]
                                z = data[:, 2]

                    # å¦‚æœæ‰¾ä¸åˆ°æ•°æ®ï¼Œæ‰“å°æ–‡ä»¶ç»“æ„å¸®åŠ©è°ƒè¯•
                    if x is None or y is None or z is None:
                        print("  æ–‡ä»¶ç»“æ„:")


                        def print_structure(name, obj):
                            if isinstance(obj, h5py.Dataset):
                                print(f"    - æ•°æ®é›†: {name} (å½¢çŠ¶: {obj.shape})")
                            elif isinstance(obj, h5py.Group):
                                print(f"    - ç»„: {name}")


                        f.visititems(print_structure)
                        raise ValueError("æœªæ‰¾åˆ°æŒ¯åŠ¨æ•°æ®")

                    # ç¡®ä¿XYZé•¿åº¦ä¸€è‡´
                    min_len = min(len(x), len(y), len(z))
                    if min_len == 0:
                        print("  âš ï¸ æ•°æ®é•¿åº¦ä¸º0ï¼Œè·³è¿‡æ–‡ä»¶")
                        continue

                    # åˆ›å»ºç²¾ç®€çš„DataFrame - åªä¿ç•™å¿…è¦æ•°æ®
                    # åˆ—æ ‡é¢˜ä¸º: 0, 1, 2, is_defect
                    df = pd.DataFrame({
                        '0': x[:min_len],  # æŒ¯åŠ¨æ•°æ®é€šé“0
                        '1': y[:min_len],  # æŒ¯åŠ¨æ•°æ®é€šé“1
                        '2': z[:min_len],  # æŒ¯åŠ¨æ•°æ®é€šé“2
                        'is_defect': [1] * min_len if quality == "bad" else [0] * min_len  # è´¨é‡æ ‡ç­¾
                    })

                    process_data.append(df)
                    processed_files += 1
                    print(f"  âœ… æå–æˆåŠŸ (è¡Œ: {min_len})")
            except Exception as e:
                print(f"  âŒ å¤±è´¥: {str(e)}")

    # ä¿å­˜è¯¥å·¥åºçš„æ•°æ®
    if process_data:
        combined = pd.concat(process_data, ignore_index=True)
        save_path = os.path.join(output_dir, f"{machine}_{process_id}_data.csv")

        # ç›´æ¥ä¿å­˜ç²¾ç®€æ•°æ®
        combined.to_csv(save_path, index=False)

        elapsed_time = time.time() - start_time

        # è®¡ç®—æ–‡ä»¶å¤§å°
        file_size = os.path.getsize(save_path) / (1024 * 1024)  # MB

        print(f"\nâœ… å·¥åº {process_id} å¤„ç†å®Œæˆï¼")
        print(f"  - å…±å¤„ç† {processed_files} ä¸ªæ–‡ä»¶")
        print(f"  - æ•°æ®å¤§å°: {len(combined)} è¡Œ")
        print(f"  - æ–‡ä»¶å¤§å°: {file_size:.2f} MB")
        print(f"  - è€—æ—¶: {elapsed_time:.2f} ç§’")
        print(f"  - ä¿å­˜åˆ°: {save_path}")

        # æ‰“å°æ–‡ä»¶å‰å‡ è¡Œé¢„è§ˆ
        print("\næ–‡ä»¶å‰5è¡Œé¢„è§ˆ:")
        print(combined.head())
    else:
        print(f"\nâŒ å·¥åº {process_id} æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼")

print(f"\nğŸ‰ è®¾å¤‡ {machine} æ‰€æœ‰å·¥åºå¤„ç†å®Œæˆï¼")
