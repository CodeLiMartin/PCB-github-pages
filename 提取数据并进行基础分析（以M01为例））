import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats
import os
from pathlib import Path
import h5py

# è®¾ç½®ä¸­æ–‡å­—ä½“ï¼ˆç®€åŒ–ä¸ºåªä½¿ç”¨SimHeiï¼‰
plt.rcParams["font.family"] = ["SimHei"]
plt.rcParams['axes.unicode_minus'] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜

# è¾“å‡ºç›®å½•
output_dir = r"D:\PCBä»¿çœŸ\CNC_Machining-main\M01_analysis"
os.makedirs(output_dir, exist_ok=True)


# æ­¥éª¤1ï¼šè¯»å–åŸå§‹H5æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
def load_raw_h5_data(machine="M01"):
    """ç›´æ¥ä»åŸå§‹H5æ–‡ä»¶åŠ è½½æ•°æ®ï¼Œä¼˜åŒ–vibration_dataçš„æå–"""
    root_dir = r"D:\PCBä»¿çœŸ\CNC_Machining-main\data"  # ä½¿ç”¨æ‚¨æä¾›çš„è·¯å¾„
    all_data = []

    # éå†å·¥åºï¼ˆOP00-OP14ï¼‰
    for op in range(15):
        op_id = f"OP{op:02d}"
        op_path = os.path.join(root_dir, machine, op_id)

        if not os.path.exists(op_path):
            print(f"âš ï¸ å·¥åº {op_id} ä¸å­˜åœ¨ï¼Œè·³è¿‡")
            continue

        # éå†è‰¯å“/ä¸è‰¯å“
        for quality in ["good", "bad"]:
            quality_path = os.path.join(op_path, quality)

            if not os.path.exists(quality_path):
                print(f"âš ï¸ å·¥åº {op_id} çš„ {quality} æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè·³è¿‡")
                continue

            # éå†H5æ–‡ä»¶
            for file in os.listdir(quality_path):
                if not file.endswith(".h5"):
                    continue

                file_path = os.path.join(quality_path, file)
                try:
                    with h5py.File(file_path, "r") as f:
                        # æ‰“å°æ–‡ä»¶ç»“æ„ï¼Œå¸®åŠ©è°ƒè¯•
                        print(f"\nğŸ“ æ–‡ä»¶ç»“æ„: {file}")
                        print(f"  æ ¹ç›®å½•ä¸‹å¯¹è±¡: {list(f.keys())}")

                        # æå–æŒ¯åŠ¨æ•°æ®
                        data = extract_vibration_data(f)

                        if data is not None:
                            # åˆ›å»ºDataFrame
                            df = pd.DataFrame({
                                '0': data.get('0', []),  # æŒ¯åŠ¨X
                                '1': data.get('1', []),  # æŒ¯åŠ¨Y
                                '2': data.get('2', []),  # æŒ¯åŠ¨Z
                                'machine': machine,
                                'process': op_id,
                                'is_defect': (quality == "bad"),
                                'file_name': file
                            })

                            all_data.append(df)
                            print(f"âœ… å·²åŠ è½½ {file} ({op_id}/{quality})")
                        else:
                            print(f"âŒ æ— æ³•ä» {file} æå–æŒ¯åŠ¨æ•°æ®")

                except Exception as e:
                    print(f"âŒ åŠ è½½ {file} å¤±è´¥: {str(e)[:50]}")

    if all_data:
        combined = pd.concat(all_data, ignore_index=True)
        print(f"\nğŸ‰ æˆåŠŸåŠ è½½ {len(combined)} è¡Œæ•°æ®ï¼Œæ¥è‡ª {len(all_data)} ä¸ªH5æ–‡ä»¶")
        return combined
    else:
        print(f"âŒ æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨çš„ {machine} æ•°æ®")
        return None


# è¾…åŠ©å‡½æ•°ï¼šä»H5æ–‡ä»¶ä¸­æå–æŒ¯åŠ¨æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
def extract_vibration_data(h5_file):
    """ä¼˜åŒ–vibration_dataçš„æå–é€»è¾‘"""
    # æ–¹æ³•1ï¼šç›´æ¥è¯»å–æ•°æ®é›†ï¼ˆä¹‹å‰çš„æ–¹å¼ï¼‰
    try:
        return {
            '0': h5_file['0'][:],
            '1': h5_file['1'][:],
            '2': h5_file['2'][:]
        }
    except KeyError:
        pass

    # æ–¹æ³•2ï¼šå‡è®¾ '0', '1', '2' æ˜¯ç»„ï¼Œå°è¯•ä»ç»„ä¸­è¯»å–æ•°æ®
    try:
        return {
            '0': h5_file['0']['data'][:],
            '1': h5_file['1']['data'][:],
            '2': h5_file['2']['data'][:]
        }
    except KeyError:
        pass

    # æ–¹æ³•3ï¼šå°è¯•ä»vibration_dataæå–ä¸‰è½´æŒ¯åŠ¨
    try:
        vibration_data = h5_file['vibration_data'][:]

        # æ£€æŸ¥æ•°æ®å½¢çŠ¶ï¼Œç¡®å®šå¦‚ä½•åˆ†ç¦»ä¸‰è½´
        if len(vibration_data.shape) == 1:
            # å¯èƒ½æ˜¯ä¸€ç»´æ•°ç»„ï¼Œå°è¯•å‡åŒ€åˆ†å‰²ä¸ºä¸‰éƒ¨åˆ†
            length = len(vibration_data)
            if length % 3 == 0:
                segment = length // 3
                return {
                    '0': vibration_data[:segment],
                    '1': vibration_data[segment:2 * segment],
                    '2': vibration_data[2 * segment:]
                }
            else:
                print(f"  âŒ æ–¹æ³•3å¤±è´¥ï¼švibration_dataå½¢çŠ¶ä¸º {vibration_data.shape}ï¼Œæ— æ³•å‡åŒ€åˆ†å‰²")

        elif len(vibration_data.shape) == 2:
            # äºŒç»´æ•°ç»„ï¼Œå¯èƒ½æ˜¯ [æ ·æœ¬æ•°, 3] æˆ– [3, æ ·æœ¬æ•°]
            if vibration_data.shape[1] == 3:  # [æ ·æœ¬æ•°, 3]
                return {
                    '0': vibration_data[:, 0],  # Xè½´
                    '1': vibration_data[:, 1],  # Yè½´
                    '2': vibration_data[:, 2]  # Zè½´
                }
            elif vibration_data.shape[0] == 3:  # [3, æ ·æœ¬æ•°]
                return {
                    '0': vibration_data[0, :],  # Xè½´
                    '1': vibration_data[1, :],  # Yè½´
                    '2': vibration_data[2, :]  # Zè½´
                }
            else:
                print(f"  âŒ æ–¹æ³•3å¤±è´¥ï¼švibration_dataå½¢çŠ¶ä¸º {vibration_data.shape}ï¼Œä¸æ˜¯é¢„æœŸçš„ä¸‰è½´æ•°æ®")

        else:
            print(f"  âŒ æ–¹æ³•3å¤±è´¥ï¼švibration_dataç»´åº¦ {len(vibration_data.shape)} ä¸æ”¯æŒ")

    except Exception as e:
        print(f"  âŒ æ–¹æ³•3å¤±è´¥: {str(e)[:50]}")

    # æ–¹æ³•4ï¼šè¿”å›ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç»“æ„ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    if not hasattr(extract_vibration_data, 'structure_printed'):
        print("\nğŸ“‹ H5æ–‡ä»¶è¯¦ç»†ç»“æ„ä¿¡æ¯:")
        h5_file.visititems(print_h5_structure)
        extract_vibration_data.structure_printed = True

    return None


# è¾…åŠ©å‡½æ•°ï¼šæ‰“å°H5æ–‡ä»¶ç»“æ„
def print_h5_structure(name, obj):
    """é€’å½’æ‰“å°H5æ–‡ä»¶çš„ç»“æ„"""
    if isinstance(obj, h5py.Dataset):
        print(f"  ğŸ“„ æ•°æ®é›†: {name}, å½¢çŠ¶: {obj.shape}, ç±»å‹: {obj.dtype}")
    elif isinstance(obj, h5py.Group):
        print(f"  ğŸ“ ç»„: {name}")


# æ­¥éª¤2ï¼šåˆ†æç‰¹å®šå·¥åºï¼ˆä»¥OP05ä¸ºä¾‹ï¼‰
def analyze_process(df, process_id="OP05", target_axis="2"):
    """åˆ†ææŒ‡å®šå·¥åºçš„æŒ¯åŠ¨æ•°æ®å’Œä¸è‰¯å“å…³è”"""
    if df is None:
        return

    # ç­›é€‰å·¥åºæ•°æ®
    process_data = df[df['process'] == process_id].copy()
    if process_data.empty:
        print(f"âŒ å·¥åº {process_id} æ— æ•°æ®")
        return

    print(f"\n===== åˆ†æå·¥åº {process_id} =====")
    print(f"æ€»æ ·æœ¬æ•°: {len(process_data)}")
    print(f"è‰¯å“æ•°: {len(process_data[process_data['is_defect'] == False])}")
    print(f"ä¸è‰¯å“æ•°: {len(process_data[process_data['is_defect'] == True])}")

    # 1. ç®±çº¿å›¾å¯¹æ¯”è‰¯å“/ä¸è‰¯å“çš„æŒ¯åŠ¨åˆ†å¸ƒ
    plt.figure(figsize=(10, 6))
    sns.boxplot(x='is_defect', y=target_axis, data=process_data)
    plt.title(f"{process_id} å·¥åº: è‰¯å“ vs ä¸è‰¯å“çš„æŒ¯åŠ¨{target_axis}åˆ†å¸ƒ")
    plt.xlabel("æ˜¯å¦ä¸è‰¯å“")
    plt.ylabel(f"æŒ¯åŠ¨{target_axis}å€¼")
    plt.xticks([0, 1], ['è‰¯å“', 'ä¸è‰¯å“'])
    plt.savefig(os.path.join(output_dir, f"{process_id}_boxplot.png"), dpi=300, bbox_inches='tight')
    plt.close()

    # è®¡ç®—ç»Ÿè®¡å·®å¼‚
    good_values = process_data[process_data['is_defect'] == False][target_axis]
    bad_values = process_data[process_data['is_defect'] == True][target_axis]

    # 2. è¿‡ç¨‹èƒ½åŠ›åˆ†æï¼ˆå‡è®¾è§„æ ¼ä¸Šé™USL=0.5ï¼‰
    def calculate_cpk(values, usl=0.5, lsl=0):
        """è®¡ç®—è¿‡ç¨‹èƒ½åŠ›æŒ‡æ•°CPK"""
        mean = np.mean(values)
        std = np.std(values)

        cpl = (mean - lsl) / (3 * std)
        cpu = (usl - mean) / (3 * std)
        cpk = min(cpl, cpu)

        return {
            'å¹³å‡å€¼': mean,
            'æ ‡å‡†å·®': std,
            'CPL': cpl,
            'CPU': cpu,
            'CPK': cpk
        }

    cpk_results = calculate_cpk(process_data[target_axis])
    print("\nè¿‡ç¨‹èƒ½åŠ›åˆ†æç»“æœ:")
    for key, value in cpk_results.items():
        print(f"  {key}: {value:.4f}")

    # 3. ä¸è‰¯å“æŒ¯åŠ¨é˜ˆå€¼åˆ†æ
    print("\nä¸è‰¯å“æŒ¯åŠ¨é˜ˆå€¼åˆ†æ:")
    bad_stats = bad_values.describe()
    print(f"  ä¸è‰¯å“æŒ¯åŠ¨{target_axis}å¹³å‡å€¼: {bad_stats['mean']:.4f}")
    print(f"  ä¸è‰¯å“æŒ¯åŠ¨{target_axis}ä¸­ä½æ•°: {bad_stats['50%']:.4f}")
    print(f"  ä¸è‰¯å“æŒ¯åŠ¨{target_axis}80%åˆ†ä½æ•°: {np.percentile(bad_values, 80):.4f}")

    # 4. å…³è”åˆ†æï¼ˆæŒ¯åŠ¨ä¸ä¸è‰¯çš„ç›¸å…³æ€§ï¼‰
    # å°†å¸ƒå°”å€¼è½¬ä¸ºæ•°å€¼
    process_data['is_defect_num'] = process_data['is_defect'].astype(int)

    # è®¡ç®—æŒ¯åŠ¨è½´ä¸ä¸è‰¯çš„ç›¸å…³ç³»æ•°
    correlations = {}
    for axis in ['0', '1', '2']:  # X, Y, Zè½´
        corr = process_data[axis].corr(process_data['is_defect_num'])
        correlations[axis] = corr
        print(f"  æŒ¯åŠ¨{axis}ä¸ä¸è‰¯çš„ç›¸å…³ç³»æ•°: {corr:.4f}")

    # ç»˜åˆ¶ç›¸å…³æ€§çƒ­å›¾
    plt.figure(figsize=(8, 6))
    corr_matrix = process_data[['0', '1', '2', 'is_defect_num']].corr()
    sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt='.2f')
    plt.title(f"{process_id} å·¥åº: æŒ¯åŠ¨ä¸ä¸è‰¯çš„ç›¸å…³æ€§")
    plt.savefig(os.path.join(output_dir, f"{process_id}_correlation.png"), dpi=300, bbox_inches='tight')
    plt.close()

    # ä¿å­˜åˆ†æç»“æœåˆ°CSV
    process_stats = process_data.groupby('is_defect')[target_axis].describe()
    process_stats.to_csv(os.path.join(output_dir, f"{process_id}_stats.csv"))

    return {
        'process_id': process_id,
        'cpk': cpk_results['CPK'],
        'bad_mean': bad_stats['mean'],
        'bad_80pct': np.percentile(bad_values, 80),
        'correlations': correlations
    }


# æ­¥éª¤3ï¼šåˆ†ææ‰€æœ‰å·¥åºï¼Œæ‰¾å‡ºä¸è‰¯ç‡æœ€é«˜çš„å·¥åº
def analyze_all_processes(df, target_axis="2"):
    """åˆ†ææ‰€æœ‰å·¥åºçš„ä¸è‰¯æƒ…å†µå’ŒæŒ¯åŠ¨ç‰¹å¾"""
    if df is None:
        return

    # ç»Ÿè®¡å„å·¥åºçš„ä¸è‰¯ç‡
    process_stats = df.groupby('process').agg(
        total_count=('process', 'count'),
        defect_count=('is_defect', 'sum'),
        defect_rate=('is_defect', 'mean')
    ).reset_index()

    # æŒ‰ä¸è‰¯ç‡æ’åº
    process_stats = process_stats.sort_values('defect_rate', ascending=False)

    # ç»˜åˆ¶å¸•ç´¯æ‰˜å›¾
    plt.figure(figsize=(12, 6))
    ax1 = plt.subplot(111)
    ax1.bar(process_stats['process'], process_stats['defect_count'], color='blue')
    ax1.set_ylabel('ä¸è‰¯å“æ•°é‡', color='blue')

    ax2 = ax1.twinx()
    ax2.plot(process_stats['process'], process_stats['defect_rate'].cumsum() / process_stats['defect_rate'].sum(),
             color='red', marker='o')
    ax2.set_ylabel('ç´¯ç§¯ä¸è‰¯ç‡', color='red')
    ax2.set_ylim(0, 1.1)

    plt.title('å„å·¥åºä¸è‰¯å“æ•°é‡åŠç´¯ç§¯ä¸è‰¯ç‡')
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.savefig(os.path.join(output_dir, "process_pareto.png"), dpi=300, bbox_inches='tight')
    plt.close()

    # åˆ†æå„å·¥åºçš„æŒ¯åŠ¨ç‰¹å¾
    process_vibration = df.groupby('process').agg(
        vibration_mean=(target_axis, 'mean'),
        vibration_std=(target_axis, 'std')
    ).reset_index()

    # åˆå¹¶ä¸è‰¯ç‡å’ŒæŒ¯åŠ¨ç‰¹å¾
    process_summary = pd.merge(process_stats, process_vibration, on='process')

    # ä¿å­˜å·¥åºåˆ†æç»“æœ
    process_summary.to_csv(os.path.join(output_dir, "all_process_summary.csv"), index=False)

    print("\n===== å„å·¥åºåˆ†æç»“æœ =====")
    print(process_summary)

    return process_summary


# æ­¥éª¤4ï¼šæ‰¾å‡ºæŒ¯åŠ¨å¼‚å¸¸çš„å·¥åº
def identify_abnormal_processes(df, process_summary, target_axis="2", threshold=1.5):
    """æ‰¾å‡ºæŒ¯åŠ¨ç‰¹å¾å¼‚å¸¸çš„å·¥åº"""
    if df is None:
        return

    # è®¡ç®—æ‰€æœ‰å·¥åºæŒ¯åŠ¨çš„å¹³å‡å€¼å’Œæ ‡å‡†å·®
    overall_mean = df[target_axis].mean()
    overall_std = df[target_axis].std()

    # æ‰¾å‡ºæŒ¯åŠ¨å‡å€¼å¼‚å¸¸çš„å·¥åº
    abnormal_mean = process_summary[
        (process_summary['vibration_mean'] > overall_mean + threshold * overall_std) |
        (process_summary['vibration_mean'] < overall_mean - threshold * overall_std)
        ]

    # æ‰¾å‡ºæŒ¯åŠ¨ç¦»æ•£åº¦å¼‚å¸¸çš„å·¥åº
    abnormal_std = process_summary[
        process_summary['vibration_std'] > process_summary['vibration_std'].mean() + threshold * process_summary[
            'vibration_std'].std()
        ]

    print("\n===== æŒ¯åŠ¨å‡å€¼å¼‚å¸¸çš„å·¥åº =====")
    print(abnormal_mean[['process', 'vibration_mean', 'defect_rate']])

    print("\n===== æŒ¯åŠ¨ç¦»æ•£åº¦å¼‚å¸¸çš„å·¥åº =====")
    print(abnormal_std[['process', 'vibration_std', 'defect_rate']])

    # ä¿å­˜å¼‚å¸¸å·¥åº
    abnormal_mean.to_csv(os.path.join(output_dir, "abnormal_mean_processes.csv"), index=False)
    abnormal_std.to_csv(os.path.join(output_dir, "abnormal_std_processes.csv"), index=False)

    return {
        'abnormal_mean': abnormal_mean,
        'abnormal_std': abnormal_std
    }


# ä¸»å‡½æ•°ï¼šæ‰§è¡Œå®Œæ•´åˆ†ææµç¨‹
def run_analysis(machine="M01", target_axis="2", focus_process=None):
    """æ‰§è¡Œå®Œæ•´çš„åˆ†ææµç¨‹"""
    print(f"\n===== å¼€å§‹åˆ†æ {machine} è®¾å¤‡æ•°æ® =====")

    # åŠ è½½åŸå§‹H5æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    df = load_raw_h5_data(machine)
    if df is None:
        return

    # åˆ†æç‰¹å®šå·¥åºï¼ˆå¦‚æœæŒ‡å®šï¼‰
    if focus_process:
        process_result = analyze_process(df, process_id=focus_process, target_axis=target_axis)
        if process_result:
            print(f"\né‡ç‚¹å·¥åº {focus_process} åˆ†æå®Œæˆï¼")
            print(f"  - CPKå€¼: {process_result['cpk']:.4f}")
            print(f"  - ä¸è‰¯å“æŒ¯åŠ¨{target_axis}å¹³å‡å€¼: {process_result['bad_mean']:.4f}")
            print(f"  - æŒ¯åŠ¨{target_axis}ä¸ä¸è‰¯çš„ç›¸å…³ç³»æ•°: {process_result['correlations'][target_axis]:.4f}")

    # åˆ†ææ‰€æœ‰å·¥åº
    process_summary = analyze_all_processes(df, target_axis=target_axis)

    # æ‰¾å‡ºå¼‚å¸¸å·¥åº
    abnormal_processes = identify_abnormal_processes(df, process_summary, target_axis=target_axis)

    print(f"\nğŸ‰ {machine} è®¾å¤‡æ•°æ®åˆ†æå®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ° {output_dir}")
    print(
        f"é‡ç‚¹å»ºè®®ï¼šä¼˜å…ˆä¼˜åŒ–ä¸è‰¯ç‡æœ€é«˜çš„å·¥åºï¼ˆ{process_summary.iloc[0]['process']}ï¼Œä¸è‰¯ç‡ï¼š{process_summary.iloc[0]['defect_rate']:.2%}ï¼‰")

    # ä¿å­˜åˆå¹¶åçš„æ•°æ®
    df.to_csv(os.path.join(output_dir, f"{machine}_combined_data.csv"), index=False)

    return {
        'data': df,
        'process_summary': process_summary,
        'abnormal_processes': abnormal_processes
    }


# æ‰§è¡Œåˆ†æï¼ˆé»˜è®¤åˆ†æM01è®¾å¤‡ï¼Œé‡ç‚¹å…³æ³¨OP05å·¥åºï¼‰
if __name__ == "__main__":
    results = run_analysis(machine="M01", target_axis="2", focus_process="OP05")
